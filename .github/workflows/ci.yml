name: Continuous Integration

on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  changed:
    name: Changed
    uses: ./.github/workflows/changes.yml

  test-parse:
    name: Data Files
    runs-on: ubuntu-latest
    env:
      CONTINUOUS: Endless_Sky-continuous-x86_64.AppImage
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    needs: changed
    if: ${{ needs.changed.outputs.workflows == 'true' || needs.changed.outputs.data_files == 'true' }}
    steps:
    - name: Download latest continuous
      run: gh release download -R endless-sky/endless-sky continuous -p ${{ env.CONTINUOUS }}
    - name: Extract and prepare continuous
      run: |
        mv * endless-sky
        cd endless-sky
        mkdir plugins
        cd plugins
        mkdir merchant-campaign
    - uses: actions/checkout@v4
      with:
        path: 'endless-sky/plugins/merchant-campaign'
    - name: Parse Datafiles
      run: "'endless-sky/Endless Sky' -p"
      shell: bash
